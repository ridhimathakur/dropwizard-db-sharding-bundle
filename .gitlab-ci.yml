.default_tags: &default_tags
  tags:
    - backend-docker-large

image: docker.phonepe.com/pp-maven:3.9.5-openjdk-17



stages:
  - build
  - merge
  - deploy
  - release

"Compile":
  <<: *default_tags
  stage: build
  script:
    - mvn clean package -DskipTests
  only:
    - merge_requests
  except:
    - master
    - develop
  when: manual


"Test cases - PR":
  <<: *default_tags
  stage: merge
  allow_failure: false
  only:
    - merge_requests
  except:
    - master
    - develop
  when: manual
  script:
    - export MAVEN_OPTS="-Xms4g -Xmx4g"
    - mvn verify -U -Pquality_check -Psirius -Dsonar.java.experimental.batchModeSizeInKB=1024 -Dsonar.pullrequest.key="$CI_MERGE_REQUEST_IID" -Dsonar.pullrequest.branch="$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" -Dsonar.pullrequest.base="$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
  tags:
    - backend-docker-large

"Deploy snapshot":
  <<: *default_tags
  stage: deploy
  script:
    - mvn deploy -DskipTests=true -U -Pdocker
  when: manual
  only:
    refs:
      - db-sharding-bundle

"Release":
  <<: *default_tags
  stage: release
  script:
    - export MAVEN_OPTS="-Xms4g -Xmx4g"
    - git remote set-url origin "git@gitlab.phonepe.com:${CI_PROJECT_PATH}.git"
    - git checkout master
    - git pull origin master
    - git checkout develop
    - git pull origin develop
    - mvn -U -Pdocker -Dsonar.branch.name=develop -Dsonar.java.experimental.batchModeSizeInKB=1024 jgitflow:release-start jgitflow:release-finish -D maven.release.ignore.snapshots=true
    - git push --all
    - git push --tags origin
  when: manual
  only:
    refs:
      - develop
  tags:
    - backend-docker-large


"Bump Version":
  <<: *default_tags
  stage: release
  script:
    - git remote set-url origin "git@gitlab.phonepe.com:${CI_PROJECT_PATH}.git"
    - git checkout develop
    - git pull origin develop
    - mvn build-helper:parse-version versions:set -DnewVersion="\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion}\${parsedVersion.qualifier?}" versions:commit
    - VERSION="$(mvn -q help:evaluate -Dexpression=project.version -DforceStdout)"
    - git commit -am "[Gitlab CI] Version bumped to ${VERSION} by ${GITLAB_USER_NAME}"
    - git push origin develop
  only:
    refs:
      - develop
    variables:
      - $BUMP_VERSION == "true"
  when: manual
